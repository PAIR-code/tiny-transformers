@let sec = section();
@let data = sec.defData();

<div class="small-buttons">
  @if (collapsed()) {
    <button
      class="hostHoverAppear left-margin"
      (click)="collapsed.set(false)"
      mat-icon-button
    >
      <mat-icon svgIcon="keyboard_arrow_down">uncollapse</mat-icon>
    </button>
  } @else {
    <button
      mat-icon-button
      class="hostHoverAppear left-margin"
      (click)="collapsed.set(true)"
    >
      <mat-icon svgIcon="keyboard_arrow_up">collapse</mat-icon>
    </button>
  }

  <button
    class="hostHoverAppear left-margin"
    mat-icon-button
    matTooltip="add section"
    [matMenuTriggerFor]="expandedAddMenu"
  >
    <mat-icon svgIcon="add">+</mat-icon>
  </button>
  <mat-menu #expandedAddMenu>
    <button mat-menu-item matTooltip="Inline Code" (click)="addInlineCode()">
      inline code
    </button>
    <button mat-menu-item matTooltip="Inline Code" (click)="addVsCodeCell()">
      vscode cell
    </button>
    <button
      mat-menu-item
      matTooltip="Json Object"
      (click)="addMarkdownEditor()"
    >
      json markdown
    </button>
    <button mat-menu-item matTooltip="Json Object" (click)="addJsonObjEditor()">
      json object
    </button>
  </mat-menu>

  @if (!collapsed()) {
    <button
      mat-icon-button
      class="left-margin"
      [class.hostHoverAppear]="!editDefView()"
    >
      <mat-icon
        [svgIcon]="editDefView() ? 'settings_applications' : 'settings'"
        (click)="editDefView.set(!editDefView())"
        >settings</mat-icon
      >
    </button>
  }

  <span
    (click)="collapsed() && collapsed.set(false)"
    class="mini-id-title left-margin"
    [class.hostHoverAppear]="!collapsed()"
    >{{ data.id }}</span
  >
</div>

<div class="top-bar hostHover"></div>

@if (!collapsed()) {
  <div class="expanded-section">
    @if (editDefView()) {
      <app-codemirror-config-editor
        [whatIsBeingEditedName]="sec.defData().id"
        [defaultConfig]="'{}'"
        [config]="stringifyJsonValue(sec.defData())"
        [closable]="false"
        (update)="handleDefUpdate($event)"
      ></app-codemirror-config-editor>
    } @else {
      <!-- @if (!display().hidden) {
}  -->
      @switch (data.kind) {
        @case (SecDefKind.UiCell) {
          @switch (data.uiView) {
            @case (ViewerKind.MarkdownOutView) {
              @let markdown = sec.outputs["markdown"]();
              @if (markdown) {
                <markdown>{{ sec.outputs["markdown"]() }}</markdown>
              } @else {
                markdown not yet defined.
              }
            }
            @case (ViewerKind.JsonObjOutView) {
              @let jsonObjSignal = sec.outputs["jsonObj"];
              @if (jsonObjSignal()) {
                <app-codemirror-config-editor
                  [whatIsBeingEditedName]="sec.defData().id"
                  [defaultConfig]="'{}'"
                  [config]="stringifyJsonValue(jsonObjSignal())"
                  [closable]="false"
                  (update)="handleJsonUpdate($event, jsonObjSignal)"
                ></app-codemirror-config-editor>
              } @else {
                JSON not yet defined.
              }
            }
          }
        }
        @case (SecDefKind.WorkerCell) {
          <app-cell-section [section]="section()"></app-cell-section>
        }
        @case (SecDefKind.SectionList) {
          <div>SubExperiment</div>
        }
        @default {
          <div>Impossible/unknown sectionDataKind</div>
        }
      }
    }
  </div>
  <div class="bottom-bar hostHover"></div>
  <!-- <div class="small-buttons showOnHover">
    <span class="spacer"></span>
    

    <span class="spacer"></span>
  </div> -->
}
