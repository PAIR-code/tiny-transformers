@let sec = section();
@let data = sec.defData();

<div class="small-buttons">
  @if (collapsed()) {
    <button
      class="hostHoverIconAppear left-margin"
      (click)="uncollapse()"
      mat-icon-button
    >
      <mat-icon svgIcon="keyboard_arrow_down">uncollapse</mat-icon>
    </button>
  } @else {
    <button
      mat-icon-button
      class="hostHoverIconAppear left-margin"
      (click)="collapse()"
    >
      <mat-icon svgIcon="keyboard_arrow_up">collapse</mat-icon>
    </button>
  }

  <button
    class="hostHoverIconAppear left-margin"
    mat-icon-button
    matTooltip="add section"
    (click)="addPlaceholder()"
  >
    <mat-icon svgIcon="add">+</mat-icon>
  </button>

  @if (!collapsed()) {
    <button
      mat-icon-button
      class="left-margin"
      [class.hostHoverIconAppear]="!editDefView()"
      (click)="editDefView.set(!editDefView())"
    >
      <mat-icon [svgIcon]="editDefView() ? 'settings_applications' : 'settings'"
        >settings</mat-icon
      >
    </button>

    @if (editDefView()) {
      <button mat-icon-button class="left-margin" (click)="deleteThisSection()">
        <mat-icon [svgIcon]="'delete'">delete</mat-icon>
      </button>
    }
  }

  <span
    (click)="collapsed() && uncollapse()"
    class="mini-id-title left-margin"
    [class.hostHover]="!collapsed() && !isSingleDefinedOutputSection()"
    [class.titleAsOuput]="isSingleDefinedOutputSection()"
    >{{ data.id }}</span
  >
  @if (collapsed()) {
    @let inputs = section().inputNames();
    @if (inputs.length > 0) {
      <div class="inputChips">
        @for (idAndRef of inputs; track idAndRef.id) {
          @if (idAndRef.ref && idAndRef.ref.outputId === "jsonObj") {
            <span class="inputId chip" [class.hostHover]="!collapsed()">
              {{ idAndRef.ref.sectionId }}
            </span>
          } @else if (idAndRef.ref) {
            <span class="inputId chip" [class.hostHover]="!collapsed()">
              {{ idAndRef.ref.sectionId }}.{{ idAndRef.ref.outputId }}
            </span>
          } @else {
            <span
              class="inputId chip unfilledInput"
              [class.hostHover]="!collapsed()"
            >
              {{ idAndRef.id }}
            </span>
          }
        }
      </div>
    }

    @let outputs = section().outputNames();
    @if (outputs.length > 1) {
      <div class="ouputChips">
        @for (idAndOut of outputs; track idAndOut.id) {
          <span class="outputId chip" [class.hostHover]="!collapsed()">
            {{ idAndOut.id }}
          </span>
        }
      </div>
    }
  }
</div>

<div class="top-bar"></div>
<!-- <div class="top-bar" [class.hostHover]="collapsed()"></div> -->

@if (!collapsed()) {
  <div class="expanded-section">
    @if (editDefView()) {
      <app-codemirror-config-editor
        [whatIsBeingEditedName]="sec.defData().id"
        [defaultConfig]="'{}'"
        [config]="stringifyJsonValue(sec.defData())"
        [closable]="false"
        (update)="handleDefUpdate($event)"
      ></app-codemirror-config-editor>
    } @else {
      <!-- @if (!display().hidden) {
}  -->
      @switch (data.kind) {
        @case (SecDefKind.UiCell) {
          @switch (data.uiView) {
            @case (ViewerKind.MarkdownOutView) {
              @let markdown = sec.outputs["markdown"]();
              @if (markdown) {
                <markdown>{{ sec.outputs["markdown"]() }}</markdown>
              } @else {
                markdown not yet defined.
              }
            }
            @case (ViewerKind.JsonObjOutView) {
              @let jsonObjSignal = sec.outputs["jsonObj"];
              @if (jsonObjSignal()) {
                <app-codemirror-config-editor
                  [whatIsBeingEditedName]="sec.defData().id"
                  [defaultConfig]="'{}'"
                  [config]="stringifyJsonValue(jsonObjSignal())"
                  [closable]="false"
                  (update)="handleJsonUpdate($event, jsonObjSignal)"
                ></app-codemirror-config-editor>
              } @else {
                JSON not yet defined.
              }
            }
            @case (ViewerKind.ExampleTableView) {
              <app-example-table [section]="section()"></app-example-table>
            }
            @case (ViewerKind.SimpleChartView) {
              <app-simple-chart></app-simple-chart>
            }
          }
        }
        @case (SecDefKind.WorkerCell) {
          <app-cell-section [section]="workerSection()"></app-cell-section>
        }
        @case (SecDefKind.SectionList) {
          <div>SubExperiment</div>
        }
        @case (SecDefKind.Placeholder) {
          <app-placeholder [section]="section()"></app-placeholder>
        }
        @default {
          <div>Impossible/unknown sectionDataKind</div>
        }
      }
    }
  </div>

  <!-- <div class="bottom-bar hostHover"></div> -->
  <!-- <div class="small-buttons showOnHover">
    <span class="spacer"></span>
    

    <span class="spacer"></span>
  </div> -->
}
