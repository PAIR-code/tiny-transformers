@if (collapsed()) {
  <div class="small-buttons" (click)="collapsed.set(false)">
    <button class="hostHover left-margin" mat-icon-button>
      <mat-icon svgIcon="keyboard_arrow_down">uncollapse</mat-icon>
    </button>
    <button class="hostHoverAppear left-margin" mat-icon-button>
      <mat-icon svgIcon="add">+</mat-icon>
    </button>
    <span class="mini-id-title left-margin">{{ data.id }}</span>
    <span class="spacer"></span>
  </div>
} @else {
  <div class="small-buttons" [class.showOnHover]="!editDefView()">
    <button mat-icon-button class="left-margin" (click)="collapsed.set(true)">
      <mat-icon svgIcon="keyboard_arrow_up">collapse</mat-icon>
    </button>
    <button mat-icon-button class="left-margin">
      <mat-icon
        [svgIcon]="editDefView() ? 'settings_applications' : 'settings'"
        (click)="editDefView.set(!editDefView())"
        >settings</mat-icon
      >
    </button>
    <!-- <span class="spacer"></span> -->
  </div>
}
<div class="top-bar hostHover"></div>

@let sec = section();
@let data = sec.data();

@if (!collapsed()) {
  <div class="expanded-section">
    @if (editDefView()) {
      <app-codemirror-config-editor
        [whatIsBeingEditedName]="sec.def.id"
        [defaultConfig]="'{}'"
        [config]="stringifyJsonValue(sec.data())"
        [closable]="false"
        (update)="handleDefUpdate($event)"
      ></app-codemirror-config-editor>
    } @else {
      <!-- @if (!display().hidden) {
}  -->
      @switch (data.kind) {
        @case (SecDefKind.UiCell) {
          @switch (data.uiView) {
            @case (ViewerKind.MarkdownOutView) {
              @let markdown = sec.outputs["markdown"]();
              @if (markdown) {
                <markdown>{{ sec.outputs["markdown"]() }}</markdown>
              } @else {
                markdown not yet defined.
              }
            }
            @case (ViewerKind.JsonObjOutView) {
              @let jsonObjSignal = sec.outputs["jsonObj"];
              @if (jsonObjSignal()) {
                <app-codemirror-config-editor
                  [whatIsBeingEditedName]="sec.def.id"
                  [defaultConfig]="'{}'"
                  [config]="stringifyJsonValue(jsonObjSignal())"
                  [closable]="false"
                  (update)="handleJsonUpdate($event, jsonObjSignal)"
                ></app-codemirror-config-editor>
              } @else {
                JSON not yet defined.
              }
            }
          }
        }
        @case (SecDefKind.WorkerCell) {
          <app-cell-section [section]="section()"></app-cell-section>
        }
        @case (SecDefKind.Experiment) {
          <div>SubExperiment</div>
        }
        @default {
          <div>Impossible/unknown sectionDataKind</div>
        }
      }
    }
  </div>
  <div class="bottom-bar hostHover"></div>
  <div class="small-buttons showOnHover">
    <span class="spacer"></span>
    <button mat-icon-button>
      <mat-icon svgIcon="add">+</mat-icon>
    </button>
    <span class="spacer"></span>
  </div>
}
